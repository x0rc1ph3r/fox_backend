// Base configuration for Prisma
// This file contains the generator and datasource configuration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Entry {
  id           String @id @default(uuid())
  userAddress  String
  raffleId     String

  user         User   @relation("UserEntries", fields: [userAddress], references: [walletAddress], onDelete: Cascade, map: "entries_user_fkey")
  raffle       Raffle @relation("RaffleEntries", fields: [raffleId], references: [id], onDelete: Cascade, map: "entries_raffle_fkey")

  @@map("entries")
  @@index([userAddress])
  @@index([raffleId])
}

model PrizeData {
  id          String  @id @default(uuid())
  address     String
  mintAddress String
  mint        String
  name        String
  verified    Boolean @default(true)
  symbol      String
  decimals    Int?
  image       String
  attributes  Json?
  collection  String?
  creator     String?
  description String?
  externalUrl String?
  properties  Json?
  floor       Float?
  raffleId    String

  raffle      Raffle  @relation(fields: [raffleId], references: [id], onDelete: Cascade)

  @@map("prize_data")
  @@index([raffleId])
  @@index([mint])
  @@index([creator])
}

enum RaffleState{
    None
    Initialized
    Active
    Cancelled
    SuccessEnded
    FailedEnded
}

model Raffle {
  id             String   @id @default(uuid())
  raffle         String   @unique
  createdAt      DateTime @default(now())
  endsAt         DateTime
  state          RaffleState @default(None)
  createdBy      String
  ticketPrice    Float
  ticketTokenAddress    String @default("So11111111111111111111111111111111111111112")
  ticketSupply   Int
  ticketSold     Int      @default(0)
  claimed        Int      @default(0)
  numberOfWinners Int      @default(1)
  winnerPicked   Boolean  @default(false)
  floor          Float?
  val            Float?
  ttv            Float
  roi            Float
  entriesAddress String
  prize          String
  maxEntries     Int
  totalEntries   Int      @default(0)

  creator      User        @relation("RaffleCreator", fields: [createdBy], references: [walletAddress], onDelete: Cascade)
  favouritedBy User[]      @relation("FavouriteRaffle")
  winners      User[]      @relation("RaffleWinner")
  prizeData    PrizeData[]
  raffleEntries Entry[]      @relation("RaffleEntries")

  @@index([createdBy])
  @@index([raffle])
  @@index([endsAt])
  @@map("raffles")
}

enum TransactionType {
  DEPOSIT
  CLAIM
  PURCHASE
  REFUND
}

model Transaction {
  id            String          @id @default(uuid())
  transactionId String          @unique
  type          TransactionType
  sender        String
  receiver      String
  createdAt     DateTime        @default(now())
  amount        BigInt
  isNft         Boolean         @default(false)
  mintAddress    String          //a unified field for both token and nft transactions

  user          User            @relation(fields: [sender], references: [walletAddress])
  @@map("transactions")
  @@index([sender])
  @@index([receiver])
  @@index([transactionId])
}

model User {
  id                String   @id @default(uuid())
  walletAddress     String   @unique
  createdAt         DateTime @default(now())
  twitterId         String?   @unique
  twitterConnected  Boolean  @default(false)
  rafflesCreated    Raffle[]     @relation("RaffleCreator")
  favouriteRaffles  Raffle[]     @relation("FavouriteRaffle")
  raffleEntries     Entry[]       @relation("UserEntries")
  transactions      Transaction[]
  raffleWinnings    Raffle[]      @relation("RaffleWinner")
 
  @@map("users")
  @@index([walletAddress])
}
